if(PB.MODULES.AUTH==null){log("init auth module");PB.MODULES.AUTH={STATES:{REQUESTING_AUTH:new WsState("REQUESTING_AUTH",{"AUTH:SESSION:INIT":function(a){PB.MODULES.AUTH.DATA.actionId=a.event.data.actionId;PB.MODULES.AUTH.DATA.userAuthInitTimeout=a.event.data.userAuthInitTimeout;PB.MODULES.AUTH.gotoState(PB.MODULES.AUTH.STATES.SESSION_INIT)}}),SESSION_INIT:new WsState("SESSION_INIT",{"REMOTE:AUTH:INITIATED":function(a){PB.MODULES.AUTH.DATA.authCode=a.event.data.authCode;PB.MODULES.AUTH.DATA.userAuthConfirmTimeout=a.event.data.userAuthConfirmTimeout;PB.MODULES.AUTH.gotoState(PB.MODULES.AUTH.STATES.REMOTE_AUTH_INIT)}}),REMOTE_AUTH_INIT:new WsState("REMOTE_AUTH_INIT",{"REMOTE:AUTH:CONFIRMED":function(a){PB.MODULES.AUTH.DATA.authSessionId=a.event.data.authSessionId;PB.MODULES.AUTH.DATA.alias=a.event.data.alias;PB.MODULES.AUTH.DATA.authDuration=a.event.data.authDuration;PB.MODULES.AUTH.CONTEXT.fullAuthData=a.event.data;PB.MODULES.AUTH.gotoState(PB.MODULES.AUTH.STATES.REMOTE_AUTH_CONFIRMED)}}),REMOTE_AUTH_CONFIRMED:new WsState("REMOTE_AUTH_CONFIRMED",{"REMOTE:AUTH:RELEASED":function(a){PB.MODULES.AUTH.reset();handleSessionExpired()}}),REQUESTING_RELEASE:new WsState("REQUESTING_RELEASE",{"REMOTE:AUTH:RELEASED":function(a){PB.MODULES.AUTH.reset();handleLogout()}})},STATE:null,DATA:{},CONTEXT:{},gotoState:function(a){if(this.STATE!=null&&this.STATE.onExit){this.STATE.onExit(this.DATA,this.CONTEXT)}this.STATE=a;if(this.STATE.init){this.STATE.init(this.DATA,this.CONTEXT)}},handleEvent:function(a){PB.MODULES.AUTH.STATE.handle(a)},init:function(a){PB.pbAgent.activeState.registerHandler("AUTH:SESSION:INIT",this.handleEvent);PB.pbAgent.activeState.registerHandler("REMOTE:AUTH:INITIATED",this.handleEvent);PB.pbAgent.activeState.registerHandler("REMOTE:AUTH:CONFIRMED",this.handleEvent);PB.pbAgent.activeState.registerHandler("REMOTE:AUTH:RELEASED",this.handleEvent);PB.pbAgent.activeState.registerHandler("AUTH:SESSION:CANCELED",handleSessionCanceled);this.STATES.SESSION_INIT.init=handleAuthInit;this.STATES.REMOTE_AUTH_INIT.init=handleRemoteAuthInit;this.STATES.REMOTE_AUTH_CONFIRMED.init=handleRemoteAuthConfirmed},requestAuth:function(a){log("Request user auth: "+JSON.stringify(a));PB.MODULES.AUTH.gotoState(PB.MODULES.AUTH.STATES.REQUESTING_AUTH);PB.pbAgent.send({et:"USER:AUTH:REQUEST",data:a})},logout:function(){log("logout request");PB.MODULES.AUTH.STATE=PB.MODULES.AUTH.STATES.REQUESTING_RELEASE;var a=PB.MODULES.AUTH.DATA;PB.pbAgent.send({et:"AUTH:RELEASE:REQUEST",data:a})},reset:function(){this.STATE=null;this.DATA={};this.CONTEXT={};JSUTIL.clearInterval("authInitTimer");JSUTIL.clearInterval("authConfirmTimer")}};function getAuthModule(){return PB.MODULES.AUTH}function generateQRCode(b){var a=new QRCode(document.getElementById("qrcode"),{text:b,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}function handleAuthInit(b){var a=b.actionId;$("#qrcode").show();generateQRCode(a);log("actionId="+b.actionId);$("#msgCont").html("Scanează codul QR de mai jos, cu aplicația de mobil <a href='https://segoia.ro#apps'>Panoul de Bord</a>, pentru a te autentifica.");$("#postMsgCont").empty().show();if(!JSUTIL.isIntervalStarted("authInitTimer")){startTimer("authInitTimer",1000,b.userAuthInitTimeout,function(c,e){var d=JSUTIL.timeIntervalToText(e,[1000,60],["s","m"]);$("#postMsgCont").html("Timp rămas: "+d)})}}function startTimer(c,b,e,g){var d=new Date().getTime();var f=e;var a=function(){f=e-(new Date().getTime()-d);if(f<=0){JSUTIL.clearInterval(c)}g(c,f)};a();JSUTIL.setInterval(c,a,b)}function handleRemoteAuthInit(b){JSUTIL.clearInterval("authInitTimer");$("#msgCont").html("Introdu codul de mai jos în aplicația de mobil pentru a confirma autentificarea.");var c=b.authCode;var a=$("#passCodeCont");a.show();a.html(c);$("#qrcode").empty().hide();if(!JSUTIL.isIntervalStarted("authConfirmTimer")){startTimer("authConfirmTimer",1000,b.userAuthConfirmTimeout,function(d,f){var e=JSUTIL.timeIntervalToText(f,[1000,60],["s","m"]);$("#postMsgCont").html("Timp rămas: "+e)})}}function handleRemoteAuthConfirmed(b,a){JSUTIL.clearInterval("authConfirmTimer");doProfileSelection(b,a)}function doProfileSelection(c,b){var d=$("#dialog-confirm");d.attr("title","Selectează un profil de utilizator");var a=b.fullAuthData.userProfiles;if(a==null){return}if(a.length<1){return}if(a.length<2){onProfileSelection(a[0]);return}d.append($("<p>Selectează unul din profilele de utilizator cu care vrei să continui:</p>"));d.append(buildProfileSelectionContainer(a));d.dialog({dialogClass:"selection-dialog",resizable:false,height:"auto",width:400,modal:true,buttons:{"Renunță":function(){$(this).dialog("close").hide();$("#dialog-confirm").dialog("close").empty();$("#dialog-confirm").empty();onProfileSelectionCanceled()}}});d.show();$(".ui-dialog-titlebar-close",d).hide()}function onProfileSelectionCanceled(){var a=getAuthModule();if(a.CONTEXT.userProfile==null){handleLogout()}else{}}function onProfileSelection(b){log("Selected profile: "+b.desc);var d=getAuthModule();var c=d.CONTEXT.userProfile;d.CONTEXT.userProfile=b;$("#dialog-confirm").dialog("close").hide();$("#dialog-confirm").dialog("close").empty();$("#dialog-confirm").empty();if(c==null){var g=d.CONTEXT.fullAuthData.userProfiles;if(g!=null&&g.length>1){var a=$("#change-user-profile");a.show();a.off("click");a.click(selectNewUserProfile)}continueAfterAuth()}window.location.hash="";var h=b.targetEntity;var f=null;var e=null;if(h!=null){f=h.id;e=h.type}PB.pbAgent.send({et:"USER:PROFILE:CHANGED",data:{userType:b.userType,entityType:e,entityId:f}})}function continueAfterAuth(){$("#msgCont").html("Autentificare cu succes!");$("#qrcode").hide();$("#passCodeCont").empty().hide();var a=$("#sectionsHeader");a.find("#login").hide();a.find("#account").show();$("#postMsgCont").empty().hide()}function selectNewUserProfile(){var a=getAuthModule();log("selecing new profile");doProfileSelection(a.DATA,a.CONTEXT)}function buildProfileSelectionContainer(d){var g=$("<div>");var f=function(c){return function(){onProfileSelection(c)}};for(var e=0;e<d.length;e++){var a=d[e];var b=buildProfileItemContainer(a);g.append(b);b.click(f(a))}return g}function buildProfileItemContainer(a){var b=$("<div>").addClass("selection-div");b.html(a.desc);return b}function handleLogout(){var a=$("#sectionsHeader");a.find("#login").show();a.find("#account").hide();PB.goHome()}function handleSessionCanceled(a){PB.MODULES.AUTH.reset();$("#qrcode").empty();$("#postMsgCont").empty();$("#postMsgCont").hide();$("#passCodeCont").empty().hide();$("#msgCont").html("Timpul a expirat. <a href='#login' onclick=PB.MODULES.AUTH.requestAuth()>Încearcă din nou</a>.")}function handleSessionExpired(a){var c=$("#sectionsHeader");c.find("#login").show();c.find("#account").hide();var b=$("#dialog-confirm");b.attr("title","Sesiunea a expirat");b.html("<p>Cum vrei să continui?</p>");b.dialog({resizable:false,height:"auto",width:400,modal:true,buttons:{Autentificare:function(){$(this).dialog("close").hide();$("#login").click()},"Închide":function(){$(this).dialog("close").hide()}}});b.show()}};