var EBUS=EBUS||{logging:!1,WS:{STATES:{},STATS:{instantiated:0}}};function WsState(t,e){this.name,this.handlers=e,this.extraHandlers={}}function EventWsEndpoint(t,e,n,s){this.id="WSE-"+ ++EBUS.WS.STATS.instantiated,this.url=t,this.handlers=[this],this.activeState=s,n&&this.handlers.push(n),this.ws,this.state,this.remoteId,this.data={},this.lastEvent,this.active,e&&this.connect()}WsState.prototype=Object.create(WsState.prototype),(WsState.prototype.constructor=WsState).prototype.handle=function(t){var e=this.handlers[t.event.et];e&&e(t);var n=this.extraHandlers[t.event.et];n&&n.nh&&n.nh.forEach(function(e){try{e(t)}catch(t){self.log("error: "+t+"handler: "+e)}})},WsState.prototype.registerHandler=function(t,e){var n=this.extraHandlers[t];null==n&&(n={nh:[]},this.extraHandlers[t]=n),n.nh.push(e)},EBUS.WS.STATES.OPENED=new WsState("OPENED",{"EBUS:PEER:CONNECTED":function(t){t.wse.remoteId=t.event.params.clientId;var e={et:"EBUS:PEER:AUTH",params:{clientId:t.event.params.clientId}};t.wse.state=EBUS.WS.STATES.CONNECTED,t.wse.send(e)}}),EBUS.WS.STATES.CONNECTED=new WsState("CONNECTED",{"EBUS:PEER:AUTHENTICATED":function(t){t.wse.active=!0,t.wse.state=t.wse.activeState,t.wse.activeState.handle(t)}}),EventWsEndpoint.prototype=Object.create(EventWsEndpoint.prototype),(EventWsEndpoint.prototype.constructor=EventWsEndpoint).prototype.connect=function(){if("WebSocket"in window)this.ws=new WebSocket(this.url);else{if(!("MozWebSocket"in window))throw"WebSocket is not supported by this browser.";this.ws=new MozWebSocket(this.url)}this.bindWs()},EventWsEndpoint.prototype.close=function(){this.ws&&(this.ws.close(),this.ws=null)},EventWsEndpoint.prototype.handlersDelegate=function(t){var e=this;return function(){e.callHandlers(t,arguments)}},EventWsEndpoint.prototype.callHandlers=function(n,t){var s=this;this.handlers.forEach(function(e){try{e[n].apply(e,t)}catch(t){s.log("error: "+t+"handler: "+e+" func: "+n)}})},EventWsEndpoint.prototype.bindWs=function(){this.ws.onopen=this.handlersDelegate("onopen"),this.ws.onclose=this.handlersDelegate("onclose"),this.ws.onmessage=this.handlersDelegate("onmessage"),this.ws.onerror=this.handlersDelegate("onerror")},EventWsEndpoint.prototype.log=function(t){EBUS.logging&&console.log(this.id+" : "+t)},EventWsEndpoint.prototype.send=function(t){var e=JSON.stringify(t);this.log("sending: "+e),this.ws.send(e)},EventWsEndpoint.prototype.onopen=function(){this.state=EBUS.WS.STATES.OPENED,this.log("opened")},EventWsEndpoint.prototype.onclose=function(t){this.log("closed -> "+t)},EventWsEndpoint.prototype.onmessage=function(t){this.log("receiving: "+t.data);var e=t.data;if(e instanceof Blob){var n=new FileReader,s=this;n.onload=function(){s.handleEvent(n.result)},n.readAsText(e)}else this.handleEvent(e)},EventWsEndpoint.prototype.handleEvent=function(t){this.log("handling: "+t),this.lastEvent=JSON.parse(t),null!=this.state&&this.state.handle({event:this.lastEvent,wse:this})},EventWsEndpoint.prototype.onerror=function(t){this.log("error: "+t)};