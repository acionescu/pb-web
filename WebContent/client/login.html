<div style="width:100%; text-align:center;">
	<div id="msgCont" style="margin:auto; display:block;  font-size:17pt; color: gray;"></div>
	<div id="qrcode" style="margin:auto; display:inline-block; padding: 10pt;"></div>
	<div id="passCodeCont" style="margin:auto; display:inline-block"></div>
	<div id="postMsgCont" style="margin:auto; display:block;  font-size:15pt; color: gray;"></div>
</div>


<script>

/* generate key */

var onKeyPairReady =   window.crypto.subtle.generateKey(
	    {
		      name: "RSASSA-PKCS1-v1_5",
		      // Consider using a 4096-bit key for systems that require long-term security
		      modulusLength: 2048,
		      publicExponent: new Uint8Array([1, 0, 1]),
		      hash: "SHA-256",
		    },
		    true,
		    ["sign", "verify", "encrypt", "decrypt"]
		  );
		  
onKeyPairReady.then(keyPair => useKeyPair(keyPair));	  
	
function useKeyPair(keyPair){
log("keyPair = "+keyPair);	
crypto.subtle.exportKey("spki",keyPair.publicKey).then(exPubKey => {
    log("publicKey="+window.btoa(String.fromCharCode.apply(null, new Uint8Array(exPubKey))));
});
};

function byteArraytoString(byteArray){
    return window.btoa(String.fromCharCode.apply(null, new Uint8Array(byteArray)));
}

async function genRandomNumber(){
    var current_date = (new Date()).valueOf().toString();
    var random = Math.random().toString();

    let result = await crypto.subtle.digest('SHA-256', new TextEncoder("utf-8").encode(current_date + random));
    return result;
};

function getRandomHash(handler){
    var p=genRandomNumber();
    p.then( rn => {
	    handler(byteArraytoString(rn));
	});
    return p;
};


getRandomHash(h => {log("randomHash="+h)}).then(()=>{console.log("after hash available")});


function getRandomNumbers() {
    var array = new Uint32Array(10);
    window.crypto.getRandomValues(array);
   
    return array;
  };
  
  log("random array: "+getRandomNumbers());
  

  
  function pageRefresh(){
      log("currentState = "+PB.MODULES.AUTH.STATE);
      if(PB.MODULES.AUTH.STATE == null){
      
	  PB.MODULES.AUTH.gotoState(PB.MODULES.AUTH.STATES.REQUESTING_AUTH);
	/* send auth request */
      	PB.MODULES.AUTH.requestAuth({});
	log("state = "+ PB.MODULES.AUTH.STATE);
	$("#passCodeCont").hide();
      }
      else{
	  PB.MODULES.AUTH.gotoState(PB.MODULES.AUTH.STATE);
      }
  }
    
  JSUTIL.injectScriptToHead(
	    "./tp/qrcode.js", pageRefresh);
  

</script>