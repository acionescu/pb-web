<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="cache-control" content="no-cache" />
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, height=device-height"/>
<title>Panoul de Bord</title>

<meta property="og:image" content="https://panouldebord.ro/images/LOGOpanou_mare.png" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Panoul de Bord" />
<meta property="og:description"
	content="Susținem democrația participativă" />

<meta name="description" content="Susținem democrația participativă" />


<script src="./client/js/event-bus.js"></script>
<script src="./client/js/pb-app.js"></script>
<script src="./tp/jquery-2.1.1.js"></script>

<script src="./tp/jquery-ui.js"></script>

<link rel="stylesheet" href="./tp/jquery-ui.css">
<link rel="stylesheet" href="./css/pbapp.css?v=1.8">
<link rel="stylesheet" href="./css/nav.css?v=1.4">

<script>
    //     var agentsCount = 100;
    var agentActionDelay = 0;
    var agentStartDelay = 200;

    $(document).ready(function() {
	// 	updateTarget("/ogeg/ws/web/v0/events");

	$('.toggle-nav').click(function(e) {
	    $(this).toggleClass('active');
	    $('.menu ul').toggleClass('active');

	    e.preventDefault();

	});

    });

    var agents = [];

    var startInterval;

    var pbAgent = null;

    var sectionRefreshing = false;

    sectionsData = {};

    var lastScrollFunc;

    var wsHandler = {
	onopen : function() {
	    //                 setConnected(true);
	    //                 $("#infoCont").hide();
	    log('Info: WebSocket connection opened.');
	},
	onmessage : function(event) {
	    log('Received: ' + event.data);
	},
	onclose : function(event) {
	    //                 setConnected(false);
	    var msg = 'WebSocket connection closed, Code: ' + event.code
		    + (event.reason == "" ? "" : ", Reason: " + event.reason);

	    $("#infoCont").text(msg).show();
	    log(msg);
	}
    };

    var clientActiveState = new WsState("ACTIVE", {
	"EBUS:PEER:AUTHENTICATED" : function(ec) {
	    log("connection active");
	    $("#infoCont").text("connection active").show();
	    pbAgent.doAppInit();
	},
	"APP:INIT:DATA" : function(ec) {
	    log("init data: " + ec.event.data);
	    initSections(ec.event.data);
	},
	"SECTION:NOTIFICATIONS:REFRESH" : function(ec) {

	    refreshPublicUserDataSection(ec.event.data);
	    sectionRefreshing = false;
	}
    });

    function log(message) {

	console.log(message);
    }

    function startTest(target) {
	if (target == null) {
	    target = document.getElementById('target').value;
	}
	startAgent(target, wsHandler, clientActiveState);
    }

    function stopTest() {
	agents.forEach(function(a) {
	    a.close();
	});
    }

    function startAgent(target, handler, state) {
	pbAgent = new PbAppClient(target, false, handler, state);
	agents.push(pbAgent);
	pbAgent.connect();

    }

    function updateTarget(target) {
	if (window.location.protocol == 'http:') {
	    document.getElementById('target').value = 'ws://'
		    + window.location.host + target;
	} else {
	    document.getElementById('target').value = 'wss://'
		    + window.location.host + target;
	}
    }

    function getTargetUrl(uri) {
	if (window.location.protocol == 'http:') {
	    return 'ws://' + window.location.host + uri;
	} else {
	    return 'wss://' + window.location.host + uri;
	}
    }

    function initInfiniteScroll(refreshFunc) {
	var win = $(window);
	lastScrollFunc = function() {
	    // End of the document reached?
	    if (sectionRefreshing) {
		return;
	    }
	    if ($(document).height() - win.height() * 1.3 <= win.scrollTop()) {
		sectionRefreshing = true;
		refreshFunc();
	    }
	};
	// Each time the user scrolls
	win.scroll(lastScrollFunc);
    }

    function removeInfiniteScroll() {
	$(window).off("scroll", lastScrollFunc);
    }

    function initSections(data) {
	var sHeader = $("#sectionsHeader");
	// 	var sc = $("#sections");

	var about = $("#about");

	var sArray = [];

	for ( var i in data.sections) {
	    var s = data.sections[i];
	    sectionsData[s.id] = s;
	    log("adding section " + s.id);
	    var h = $("<li><a href='#"+s.id+"'><span>" + s.label
		    + "</span></a></li>");
	    h.attr('id', s.id);

	    about.before(h);

	    // 	    var se = $("<div id='"+s.id+"'/>");
	    // 	    se.addClass("sectionContent");
	    // 	    var sDesc = $("<div>").addClass("sectionDesc").html(s.desc);
	    // 	    se.append(sDesc);
	    // 	    sc.append(se);
	    sArray.push(s.id);

	}

	// 	sc.tabs({

	// 	    active : 0,
	// 	    activate : function(e, ui) {
	// 		log("tab selected " + ui);
	// 	    },
	// 	    create : function(e, ui) {
	// 		log("tab created " + ui.tab);
	// 		sc.tabs("option", "active", 0);
	// 		var selectedTab = sc.tabs('option', 'active');
	// 		pbAgent.refreshSection({
	// 		    sectionId : sArray[selectedTab],
	// 		    startItem : 0,
	// 		    itemCount : 10
	// 		});
	// 	    }

	// 	});

	// 	sc.click('tabselect', function(event, ui) {
	// 	    var selectedTab = sc.tabs('option', 'active');
	// 	    log("selected tab " + selectedTab + "->" + sArray[selectedTab]);
	// 	    pbAgent.refreshSection({
	// 		sectionId : sArray[selectedTab],
	// 		startItem : 0,
	// 		itemCount : 10
	// 	    });
	// 	});

	// 	sc.tabs("option", "active", 0);

	// 	initInfiniteScroll(getSectionRefreshFunction("web_s0", 10));

	$(".menu ul li").click(
		function(e) {
		    $(".menu ul .current-item").toggleClass("current-item");
		    $(this).toggleClass("current-item");
		    var cid = $(this).attr('id');
		    log("selected: " + cid);

		    $("#contentDesc").empty();
		    $("#contentBody").empty();

		    var sData = sectionsData[cid];
		    removeInfiniteScroll();
		    if (sData) {
			initInfiniteScroll(getSectionRefreshFunction(cid, 10));
			$("#contentDesc").html(sData.desc);

			pbAgent.refreshSection({
			    sectionId : cid,
			    startItem : 0,
			    itemCount : 10
			});
		    } else {
			$("#contentBody").load(
				"./client/"
					+ $(this).find("a").first()
						.attr('href').substr(1)
					+ ".html");
		    }
		    window.location.hash = '#' + cid;
		});

	/* generate load first item */

	$(".menu ul li").first().click();
    }

    function getSectionRefreshFunction(sid, itemCount) {
	return function() {
	    log("calling refresh for section " + sid);
	    pbAgent.refreshSection({
		sectionId : sid,
		startItem : $("#contentBody").children().length,
		itemCount : itemCount
	    });
	}
    }

    function refreshPublicUserDataSection(data) {
	for ( var i in data.data.notifications) {
	    var n = data.data.notifications[i];
	    var ne = $("#nTemplate").clone();
	    ne.attr('id', "notif-" + $("#contentBody").children().length);
	    var content = n.content.replace(/\n/g, "<br/>");
	    ne.find(".notifHeader").first().html(
		    "Către: " + n.targetInstitutionName);
	    ne.find(".notifBody").first().html(content);

	    // 	    $("#" + data.id).append(ne);
	    $("#contentBody").append(ne);
	    ne.show();
	}
    }

    startTest(getTargetUrl("/ogegmob/ws/web/v0/events"));
</script>


</head>

<body>

	<div id="header" class="header">
		<div class="logoButton">
			<img src="./images/LOGOpanou.png">
			<div class="headerButtons">
				<a class="button" href="https://segoia.ro/#apps">Instalează</a>
			</div>
		</div>
	</div>
	<div id="controls" hidden="true">
		<div>
			<input id="target" type="text" size="40" style="width: 350px" />

		</div>
		<div id="infoCont" style="display: none;"></div>
		<button onclick="startTest()">Start</button>
		<button onclick="stopTest()">Stop</button>

	</div>
	<a class="toggle-nav" href="#">&#9776;</a>
	<nav class="menu">
		<ul id="sectionsHeader" class="active">
			<!-- 			<li class="current-item"><a href="#">Home</a></li> -->
			<!-- 			<li><a href="#">My Work</a></li> -->
			<!-- 			<li><a href="#">About Me</a></li> -->
			<!-- 			<li><a href="#">Get in Touch</a></li> -->
			<!-- 			<li><a href="#">Blog</a></li> -->
			<li id="about"><a href="#despre">Despre</a></li>
			<li id="toc"><a href="#toc">Termeni și condiții</a></li>
		</ul>



	</nav>

	<div id="mainContent">
		<div id="contentDesc" class="sectionDesc"></div>
		<div id="contentBody" class="sectionContent"></div>
	</div>

	<!-- 	<div id="sections" class="sectionsTabs"> -->
	<!-- 		<ul id="sectionsHeader"> -->

	<!-- 		</ul> -->
	<!-- 	</div> -->

	<div id="nTemplate" class="notification" hidden="true">
		<div class="notifHeader"></div>
		<div class="notifBody"></div>
		<div class="notifFooter"></div>
	</div>
</body>


</html>