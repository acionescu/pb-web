var agentActionDelay=0,agentStartDelay=200;$(document).ready((function(){$(".toggle-nav").click((function(e){$(this).toggleClass("active"),$(".menu ul").toggleClass("active"),e.preventDefault()})),PB.CONTROLLER=new AppController,log("init app with section: "+PB.CONTROLLER.getSection())}));var startInterval,lastScrollFunc,agents=[],sectionRefreshing=!1;sectionsData={logout:{clickHandler:PB.MODULES.AUTH.logout},detalii:{id:"detalii"}};var currentSectionData,filtersController,firstInit,sectionFilters={},lastRefreshFilters={},wsHandler={onopen:function(){log("Info: WebSocket connection opened.")},onmessage:function(event){log("Received: "+event.data)},onclose:function(event){var msg="WebSocket connection closed, Code: "+event.code+(""==event.reason?"":", Reason: "+event.reason);$("#infoCont").text(msg).show(),log(msg)}},clientActiveState=new WsState("ACTIVE",{"EBUS:PEER:AUTHENTICATED":function(ec){log("connection active"),$("#infoCont").text("connection active").show(),PB.pbAgent.doAppInit()},"APP:INIT:DATA":function(ec){log("init data: "+ec.event.data),initSections(ec.event.data)},"SECTION:NOTIFICATIONS:REFRESH":function(ec){PB.handleSectionData(ec.event.data,refreshPublicUserDataSection),sectionRefreshing=!1},"DATAFIELD:VALUES:ALLOWED_DATA":function(ec){var data=ec.event.data,f=sectionFilters[data.dataFieldId];null!=f&&(log("empty value  for "+f.df.id+" is "+data.emptyValueDesc),f.df.required||null==data.emptyValueDesc||data.allowedValues.unshift({id:data.emptyValue,desc:data.emptyValueDesc}),filtersController.onFieldValuesAvailable(data))},"APP:PETITION:DATA":function(ec){log("got app petition data"),PB.handlePetitionData(ec.event.data)}});function startTest(target){null==target&&(target=document.getElementById("target").value),startAgent(target,wsHandler,clientActiveState)}function stopTest(){agents.forEach((function(a){a.close()}))}function startAgent(target,handler,state){PB.pbAgent=new PbAppClient(target,!1,handler,state),agents.push(PB.pbAgent),PB.pbAgent.connect()}function updateTarget(target){"http:"==window.location.protocol?document.getElementById("target").value="ws://"+window.location.host+target:document.getElementById("target").value="wss://"+window.location.host+target}function getTargetUrl(uri){return"http:"==window.location.protocol?"ws://"+window.location.host+uri:"wss://"+window.location.host+uri}function getBaseUrl(){return window.location.origin+window.location.pathname}function getActionLink(action,hash){var params=new URLSearchParams;return params.set("a",action),params.set("teh",hash),getBaseUrl()+"dr?"+params.toString()}function initInfiniteScroll(refreshFunc){var win=$(window);lastScrollFunc=function(){log("refresh after scroll"),sectionRefreshing||$(document).height()-1.3*win.height()<=win.scrollTop()&&(sectionRefreshing=!0,refreshFunc())},win.scroll(lastScrollFunc)}function removeInfiniteScroll(){$(window).off("scroll",lastScrollFunc)}function menuClickListener(e){$(".menu ul .current-item").toggleClass("current-item"),$(this).toggleClass("current-item");var cid=$(this).attr("id");log("selected: "+cid),$("#contentDesc").empty(),$("#contentBody").empty();var sData=sectionsData[cid];currentSectionData=sData,removeInfiniteScroll();var viewTypeConfig,setHash=!0;sData?(sData.filters?(firstInit?(sData.defaultFilterValues={},sData.filters.requiredData.forEach((fd=>{null!=fd.value&&(sData.defaultFilterValues[fd.id]=fd.value)})),PB.CONTROLLER.getFiltersFromParams(lastRefreshFilters)):(lastRefreshFilters={},sData.defaultFilterValues&&sData.filters.requiredData.forEach((fd=>{fd.value=sData.defaultFilterValues[fd.id]}))),setupSectionFilters(sData.filters)):$("#contentFilters").hide(),$("#contentDesc").html(sData.desc),sData.clickHandler&&(setHash=!1,sData.clickHandler()),log("Try to get view config for id "+sData.id),null!=sData.id&&(viewTypeConfig=PB.getViewTypeConfigById(sData.id)),null==viewTypeConfig&&null!=sData.type&&(viewTypeConfig=PB.getViewTypeConfig(sData.type)),null!=viewTypeConfig&&null!=viewTypeConfig.page&&$("#contentBody").load("./client/"+viewTypeConfig.page,"f"+1e6*Math.random())):($("#contentFilters").hide(),$("#contentDesc").html($(this).text()),$("#contentBody").load("./client/"+$(this).find("a").first().attr("href").substr(1)+".html","f"+1e6*Math.random()));setHash&&!firstInit&&PB.CONTROLLER.setSection(cid,!0),firstInit=!1,$(".toggle-nav").hasClass("active")||($(".toggle-nav").addClass("active"),$(".menu ul").addClass("active"))}function initSections(data){PB.initData=data,PB.initModules(data);$("#sectionsHeader");var about=$("#despre");about.prevAll().remove();var sArray=[];for(var i in data.sections){var s=data.sections[i];sectionsData[s.id]=s,log("adding section "+s.id);var h=$("<li><a href='#"+s.id+"'><span>"+s.label+"</span></a></li>");h.attr("id",s.id),about.before(h),sArray.push(s.id)}$(".menu ul li").off("click"),$(".menu ul li").click(menuClickListener),$(".dropdown-content a").off("click"),$(".dropdown-content a").click(menuClickListener),firstInit=!0;var fragment=PB.CONTROLLER.getSection();if(log("fragment="+fragment),null==fragment||fragment.length<2)null!=data.defaultSection?displaySection("#"+data.defaultSection):$(".menu ul li").first().click();else{fragment="#"+fragment;var selSection=$(".menu ul").find(fragment);log("selected section: "+selSection+" length: "+selSection.length),selSection.length>0?selSection.first().click():$(".menu ul li").first().click()}}function displaySection(sectionId){var selSection=$(".menu ul").find(sectionId);selSection.length>0?selSection.first().click():$(".menu ul li").first().click()}function refreshCurrentSection(){lastRefreshFilters={};var filtersValues=getFiltersValues();log("refreshing current section "+filtersValues),PB.refreshCurrentSection(filtersValues),$("#sfBtn").attr("disabled",!0)}function getFiltersValues(){var values=[];for(var i in sectionFilters){var f=sectionFilters[i];if(f.showing){var fv=f.getUiValue();"undefined"!==fv&&(values.push({fieldValue:{id:f.df.id,value:fv}}),lastRefreshFilters[f.df.id]=fv)}}return values}function setupSectionFilters(filtersData){sectionFilters={};var filtersE=$("#contentFilters").addClass("filtersContaier");filtersE.empty();var fList=filtersData.requiredData;for(var i in filtersController=new FormDataController(fList,lastRefreshFilters),sectionFilters=filtersController.fields,log("adding "+fList.length+" filters"),sectionFilters){var fc=sectionFilters[i];log("Processing filter "+fc.df.id+" with current value "+lastRefreshFilters[fc.df.id]);var fe=buildFilterElement(fc,filtersController);null!=fe&&(fc.showing?fe.show():fe.hide(),filtersE.append(fe),fc.initUi(),fc.addChangeListener((function(ec){log(ec.df.id+" has changed"),lastRefreshFilters[ec.df.id]!=ec.getUiValue()&&$("#sfBtn").attr("disabled",!1)})))}if(filtersE.children().length>0){var btnCont=$("<div>").addClass("filterCont"),filterBtn=$("<button id='sfBtn'>").addClass("filterBtn").text("Filtrează");btnCont.append(filterBtn),filterBtn.click((function(e){refreshCurrentSection()})),filtersE.append(btnCont),filtersE.show()}else filtersE.hide()}function buildFilterElement(fc,dataContext){var filterCont=$("<div>").addClass("filterCont"),titleElem=$("<div>").addClass("filterTitle").html(fc.df.desc);if(null==fc)return null;var fe=fc.getElement(dataContext);log("got element "+fe+" for filter "+fc.df.id),filterCont.append(titleElem);var ec=$("<div>");return ec.append(fe),filterCont.append(ec),filterCont}function getSectionRefreshFunction(sid,itemCount,filterValues){return function(){log("calling refresh for section "+sid),PB.pbAgent.refreshSection({sectionId:sid,startItem:$("#contentBody").children().length,itemCount:itemCount,filtersList:filterValues})}}function refreshPublicUserDataSection(data){for(var i in data.data.notifications){var ne=buildNotifElement(data.data.notifications[i]);$("#contentBody").append(ne),ne.show()}0==$("#contentBody").children().length&&$("#contentBody").html("<div class='noContent'>Nu există înregistrări</div>")}function buildNotifElement(n){var ne=$("#nTemplate").clone();ne.attr("id","notif-"+$("#contentBody").children().length);var content=n.content.replace(/\n/g,"<br/>");if(ne.find(".notifTitle").first().html("Către: "+n.targetInstitutionName),n.hash){var actionsCont=ne.find(".notifActions"),actionLink=getActionLink("OpenEntity",n.hash),copyLinkAction=$("<a>").attr("title","Copiază link-ul").append($("<i class='actionIcon fas fa-link'></i>"));copyLinkAction.click((()=>{navigator.clipboard.writeText(actionLink),PB.showInfoMessage("Link-ul a fost copiat")})),actionsCont.append(copyLinkAction),actionsCont.append($("<a>").attr("href",actionLink).attr("target","_blank").attr("title","Deschide").append($("<i class='actionIcon fas fa-external-link-alt'></i>")))}var infoAreaVisible=!1,bodyE=ne.find(".notifBody"),statsE=ne.find(".notifStats");if(n.stats&&(statsE.append($("<span title='Susținători'>").addClass("statsItem").append($("<i class='statsIcon fas fa-users'></i>")).append(n.stats.extraStats.relevance)),statsE.append($("<span title='Prioritate pe zona de impact'>").addClass("statsItem").append($("<i class='statsIcon fas fa-hashtag'></i>")).append(n.stats.extraStats.areaPriority)),infoAreaVisible=!0),n.creatorData){var notifInfo=ne.find(".notifInfo");n.creatorData.registrationReceivedTimestamp>0&&(infoAreaVisible=!0,notifInfo.append($("<i class='notifIcon fas fa-clipboard-list' title='Număr de înregistrare primit'></i>"))),n.creatorData.responseReceivedTimestamp>0&&(infoAreaVisible=!0,notifInfo.append($("<i class='notifIcon fas fa-comment-dots' title='Răspuns primit'></i>"))),n.creatorData.resolved&&(infoAreaVisible=!0,notifInfo.append($("<i class='notifIcon fas fa-check-square' title='Marcată ca rezolvată'></i>")));var specificData=n.creatorData.specificData;if(specificData){var gpsCoords=specificData["~gpsLocation"];null!=gpsCoords&&(log("replace gps coords "+gpsCoords.lon+","+gpsCoords.lat),content=content.replace(gpsCoords.lat+","+gpsCoords.lon,'<a target="_blank" href="https://www.openstreetmap.org/?mlat='+gpsCoords.lat+"&mlon="+gpsCoords.lon+"#map=15/"+gpsCoords.lat+"/"+gpsCoords.lon+'">Vezi pe hartă</a>'))}}return infoAreaVisible&&ne.find(".notifInfoArea").show(),bodyE.append($("<div>").addClass("notifContent").html(content)),ne}startTest(getTargetUrl("/ogegmob/ws/web/v0/events"));