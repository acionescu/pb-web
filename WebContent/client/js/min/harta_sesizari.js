var mymap;var centerCoords;var geoQuery;var greenIcon,redIcon,goldIcon,orangeIcon;var selectedIssue;var mapObjects={"Rezolvată":{color:"green"},"Cu răspuns":{color:"#b57016"},"Cu număr de înregistrare":{color:"#fcf260"},"Fără răspuns":{color:"#b51616"}};function initMap(){log("initializing map");mymap=L.map("mapid");L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox/streets-v11",accessToken:"pk.eyJ1IjoiYWNpb25lc2N1IiwiYSI6ImNra250andmZDExYzYycXJxMzUxemprZ3YifQ.XJLJEliq4OfjACW9degzFg"}).addTo(mymap);var a=L.control({position:"topright"});a.onAdd=function(c){var e=L.DomUtil.create("div","info legend");log("Shwo legend "+mapObjects);for(var d in mapObjects){log("show legend for "+d);var b=mapObjects[d];e.innerHTML+='<i style="background:'+b.color+"; opacity:"+b.opacity+';">&nbsp;&nbsp;&nbsp;&nbsp;</i> '+d+"<br>"}return e};a.addTo(mymap);greenIcon=new L.Icon({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});redIcon=new L.Icon({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});goldIcon=new L.Icon({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});orangeIcon=new L.Icon({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})}JSUTIL.injectLinkToHead("https://unpkg.com/leaflet@1.5.1/dist/leaflet.css");JSUTIL.injectScriptToHead("https://unpkg.com/leaflet@1.5.1/dist/leaflet.js",pageRefresh);function getCenterPoint(){centerCoords=[45.9852129,24.6859225]}function handleData(a){var c=a.extraParams;log("Extra params: "+JSON.stringify(c));if(c!=null){var b=c.centerPoint;if(b!=null){log("Set center point: "+JSON.stringify(b));mymap.setView([b.lat,b.lon],12)}else{mymap.setView([45.9852129,24.6859225],7)}}log("Handling "+a.data.notifications.length+" notifications.");a.data.notifications.forEach(function(d){displayNotification(d)})}function formatTextToHtml(a){return a.replace(/(?:\r\n|\r|\n)/g,"<br/>")}function getMarkerClickFunction(a){return function(e){var k=$("<div>");k.append($("<b>Către "+a.targetInstitutionName+"</b>"));var d=$("<div>");k.append(d);var m=$("<ul>");d.append(m);m.append($("<li><a href='#detalii'>Detalii</a></li>"));var h=formatTextToHtml(a.content);var n=a.creatorData;var b=$("<div class='issueDetailsContent'>");d.append($("<div id='detalii'>").append(b));if(n.registrationNumber!=null){h+="<br/>Număr de înregistrare: "+n.registrationNumber}if(n.response!=null){var j=formatTextToHtml(n.response);m.append($("<li><a href='#raspuns'>Răspuns</a></li>"));var g=$("<div class='issueDetailsContent'>");g.html(j);d.append($("<div id='raspuns'>").append(g))}if(n.resolutionComment){var i=formatTextToHtml(n.resolutionComment);m.append($("<li><a href='#observatii'>Observații</a></li>"));var f=$("<div class='issueDetailsContent'>");f.html(i);d.append($("<div id='observatii'>").append(f))}k.tabs();b.html(h);return k[0]}}function displayNotification(g){if(g.creatorData.specificData==null){log("no data for "+g.targetEntityId);return}var b=g.creatorData.specificData["~gpsLocation"];if(b.lat!=null&&b.lon!=null){try{var c=g.creatorData;var a=redIcon;if(c.resolved){a=greenIcon}else{if(c.responseReceivedTimestamp>0){a=orangeIcon}else{if(c.registrationReceivedTimestamp>0){a=goldIcon}}}var d=Math.min(300,$(window).width()*0.65);L.marker([b.lat,b.lon],{icon:a}).addTo(mymap).bindPopup(getMarkerClickFunction(g),{maxWidth:d})}catch(f){log("Failed to display notif "+f+JSON.stringify(g))}}}function pageRefresh(b){if(mymap!=null){mymap.remove()}initMap();geoQuery=null;var e=getFiltersValues();if(e!=null){var c=PB.filtersListToObject(e);log("using filtersController "+filtersController);var d=filtersController.getDataForFieldValue("~county",c["~county"]);var a=filtersController.getDataForFieldValue("~uat",c["~uat"]);log("countyData="+d);log("areaData="+a);if(a!=null&&d!=null){log("refresh with county: "+JSON.stringify(d)+" ,uat: "+JSON.stringify(a));geoQuery=a.desc+", "+d.desc}}log("refresh "+currentSectionData.id+"with filters: "+b);PB.pbAgent.refreshSection({sectionId:currentSectionData.id,startItem:0,itemCount:500,filtersList:b,extraParams:{geoQuery:geoQuery}})}var self=this;PB.sectionController={refreshSection:function(a){pageRefresh(a)},onSectionData:function(a){handleData(a)}};