var agentActionDelay=0,agentStartDelay=200;$(document).ready(function(){$(".toggle-nav").click(function(t){$(this).toggleClass("active"),$(".menu ul").toggleClass("active"),t.preventDefault()})});var startInterval,lastScrollFunc,agents=[],sectionRefreshing=!1;sectionsData={};var currentSectionData,filtersController,sectionFilters={},lastRefreshFilters={},wsHandler={onopen:function(){log("Info: WebSocket connection opened.")},onmessage:function(t){log("Received: "+t.data)},onclose:function(t){var e="WebSocket connection closed, Code: "+t.code+(""==t.reason?"":", Reason: "+t.reason);$("#infoCont").text(e).show(),log(e)}},clientActiveState=new WsState("ACTIVE",{"EBUS:PEER:AUTHENTICATED":function(t){log("connection active"),$("#infoCont").text("connection active").show(),PB.pbAgent.doAppInit()},"APP:INIT:DATA":function(t){log("init data: "+t.event.data),initSections(t.event.data)},"SECTION:NOTIFICATIONS:REFRESH":function(t){refreshPublicUserDataSection(t.event.data),sectionRefreshing=!1},"DATAFIELD:VALUES:ALLOWED_DATA":function(t){var e=t.event.data,n=sectionFilters[e.dataFieldId];null!=n&&(log("empty value  for "+n.df.id+" is "+e.emptyValueDesc),n.df.required||null==e.emptyValueDesc||e.allowedValues.unshift({id:e.emptyValue,desc:e.emptyValueDesc}),filtersController.onFieldValuesAvailable(e))}});function log(t){PB.logging&&console.log(t)}function startTest(t){null==t&&(t=document.getElementById("target").value),startAgent(t,wsHandler,clientActiveState)}function stopTest(){agents.forEach(function(t){t.close()})}function startAgent(t,e,n){PB.pbAgent=new PbAppClient(t,!1,e,n),agents.push(PB.pbAgent),PB.pbAgent.connect()}function updateTarget(t){"http:"==window.location.protocol?document.getElementById("target").value="ws://"+window.location.host+t:document.getElementById("target").value="wss://"+window.location.host+t}function getTargetUrl(t){return"http:"==window.location.protocol?"ws://"+window.location.host+t:"wss://"+window.location.host+t}function initInfiniteScroll(t){var e=$(window);lastScrollFunc=function(){log("refresh after scroll"),sectionRefreshing||$(document).height()-1.3*e.height()<=e.scrollTop()&&(sectionRefreshing=!0,t())},e.scroll(lastScrollFunc)}function removeInfiniteScroll(){$(window).off("scroll",lastScrollFunc)}function initSections(t){PB.initModules(t);$("#sectionsHeader");var e=$("#despre"),n=[];for(var i in t.sections){var o=t.sections[i];log("adding section "+(sectionsData[o.id]=o).id);var l=$("<li><a href='#"+o.id+"'><span>"+o.label+"</span></a></li>");l.attr("id",o.id),e.before(l),n.push(o.id)}$(".menu ul li").click(function(t){$(".menu ul .current-item").toggleClass("current-item"),$(this).toggleClass("current-item");var e=$(this).attr("id");log("selected: "+e),$("#contentDesc").empty(),$("#contentBody").empty();var n,i=sectionsData[e];(currentSectionData=i,removeInfiniteScroll(),i)?(i.filters?setupSectionFilters(i.filters):$("#contentFilters").hide(),$("#contentDesc").html(i.desc),null!=i.type&&(n=PB.getViewTypeConfig(i.type)),null!=n&&null!=n.page&&$("#contentBody").load("./client/"+n.page,"f"+1e6*Math.random())):($("#contentFilters").hide(),$("#contentDesc").html($(this).text()),$("#contentBody").load("./client/"+$(this).find("a").first().attr("href").substr(1)+".html","f"+1e6*Math.random()));window.location.hash="#"+e,$(".toggle-nav").hasClass("active")||($(".toggle-nav").addClass("active"),$(".menu ul").addClass("active"))});var a=window.location.hash;if(log("fragment="+a),null==a||a.length<2)$(".menu ul li").first().click();else{var s=$(".menu ul").find(a);log("selected section: "+s+" length: "+s.length),0<s.length?s.first().click():$(".menu ul li").first().click()}}function refreshCurrentSection(){lastRefreshFilters={};var t=getFiltersValues();log("refreshing current section"),PB.refreshCurrentSection(t),$("#sfBtn").attr("disabled",!0)}function getFiltersValues(){var t=[];for(var e in sectionFilters){var n=sectionFilters[e];if(n.showing){var i=n.getUiValue();"undefined"!==i&&(t.push({fieldValue:{id:n.df.id,value:i}}),lastRefreshFilters[n.df.id]=i)}}return t}function setupSectionFilters(t){sectionFilters={};var e=$("#contentFilters").addClass("filtersContaier");e.empty();var n=t.requiredData;for(var i in filtersController=new FormDataController(n),sectionFilters=filtersController.fields,log("adding "+n.length+" filters"),sectionFilters){var o=sectionFilters[i];log("Processing filter "+o.df.id);var l=buildFilterElement(o,filtersController);null!=l&&(o.showing?l.show():l.hide(),e.append(l),o.initUi(),o.addChangeListener(function(t){log(t.df.id+" has changed"),lastRefreshFilters[t.df.id]!=t.getUiValue()&&$("#sfBtn").attr("disabled",!1)}))}if(0<e.children().length){var a=$("<div>").addClass("filterCont"),s=$("<button id='sfBtn'>").addClass("filterBtn").text("Filtrează");a.append(s),s.click(function(t){refreshCurrentSection()}),e.append(a),e.show()}else e.hide()}function buildFilterElement(t,e){var n=$("<div>").addClass("filterCont"),i=$("<div>").addClass("filterTitle").html(t.df.desc);if(null==t)return null;var o=t.getElement(e);log("got element "+o+" for filter "+t.df.id),n.append(i);var l=$("<div>");return l.append(o),n.append(l),n}function getSectionRefreshFunction(t,e,n){return function(){log("calling refresh for section "+t),PB.pbAgent.refreshSection({sectionId:t,startItem:$("#contentBody").children().length,itemCount:e,filtersList:n})}}function refreshPublicUserDataSection(t){for(var e in t.data.notifications){var n=t.data.notifications[e],i=$("#nTemplate").clone();i.attr("id","notif-"+$("#contentBody").children().length);var o=n.content.replace(/\n/g,"<br/>");i.find(".notifHeader").first().html("Către: "+n.targetInstitutionName);var l=i.find(".notifBody"),a=i.find(".notifStats");n.stats?(a.append($("<span title='Susținători'>").addClass("statsItem").append($("<i class='statsIcon fas fa-users'></i>")).append(n.stats.extraStats.relevance)),a.append($("<span title='Prioritate pe zona de impact'>").addClass("statsItem").append($("<i class='statsIcon fas fa-hashtag'></i>")).append(n.stats.extraStats.areaPriority))):a.hide(),l.append($("<div>").html(o)),$("#contentBody").append(i),i.show()}0==$("#contentBody").children().length&&$("#contentBody").html("<div class='noContent'>Nu există înregistrări</div>")}startTest(getTargetUrl("/ogegmob/ws/web/v0/events"));