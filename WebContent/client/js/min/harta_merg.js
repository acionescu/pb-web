console.log("load traffic page");var mymap;var mapObjects={"Zonă de plecare":{color:"#30f",opacity:0.2},"Zonă de sosire":{color:"#f03",opacity:0.2},"Trafic redus":{color:"green"},"Trafic ridicat":{color:"orange"},"Trafic intens":{color:"red"}};function initMap(){var c=PB.filtersListToObject(getFiltersValues());var a=filtersController.getDataForFieldValue("osmId",c.osmId);log("init map with osmData "+JSON.stringify(a));var e=[44.4361414,26.1027202];if(a!=null){var d=a.value.center_point;if(d!=null&&d.coordinates){e=[d.coordinates[1],d.coordinates[0]]}}mymap=L.map("mapid").setView(e,11);L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox/streets-v11",accessToken:"pk.eyJ1IjoiYWNpb25lc2N1IiwiYSI6ImNra250andmZDExYzYycXJxMzUxemprZ3YifQ.XJLJEliq4OfjACW9degzFg"}).addTo(mymap);PB.MODULES.GEO.getTrafficDensity(c);var b=L.control({position:"topright"});b.onAdd=function(g){var i=L.DomUtil.create("div","info legend");log("Shwo legend "+mapObjects);for(var h in mapObjects){log("show legend for "+h);var f=mapObjects[h];i.innerHTML+='<i style="background:'+f.color+"; opacity:"+f.opacity+';">&nbsp;&nbsp;&nbsp;&nbsp;</i> '+h+"<br>"}return i};b.addTo(mymap)}function handleTrafficDensityData(a){console.log("handle traffic data in page");var b=a.event.data.zonesTrafficDensity;for(var c in b){displayTrafficDensity(b[c])}}function encodeDensityToColor(a){if(a<2){return"green"}else{if(a<4){return"orange"}}return"red"}function metersToPixels(c,b){var a=40075016.686*Math.abs(Math.cos(c.getCenter().lat*Math.PI/180))/Math.pow(2,c.getZoom()+8);return b/a}function displayTrafficDensity(k){var h=k.departureZone;var m=k.arrivalZone;var n=k.density;var d=h.center.coordinates;var i=m.center.coordinates;var b=new L.LatLng(d[1],d[0]);var o=new L.LatLng(i[1],i[0]);var j=mymap.latLngToLayerPoint(b);var g=mymap.latLngToLayerPoint(o);var c=JSUTIL.getShortestSegmentBetweenCircles(metersToPixels(mymap,h.radius),j.x,j.y,metersToPixels(mymap,m.radius),g.x,g.y);b=mymap.layerPointToLatLng(L.point(c.p1.x,c.p1.y));o=mymap.layerPointToLatLng(L.point(c.p2.x,c.p2.y));var a=[b,o];var l=encodeDensityToColor(n);var e=new L.Polyline(a,{color:l,weight:metersToPixels(mymap,n*100),opacity:0.5,smoothFactor:1});e.addTo(mymap);var f=L.polylineDecorator(e,{patterns:[{offset:"50%",repeat:0,symbol:L.Symbol.arrowHead({pixelSize:10,polygon:false,pathOptions:{color:l,stroke:true,}})}]}).addTo(mymap);L.circle([d[1],d[0]],h.radius,{color:"none",fillColor:"#30f",fillOpacity:0.2}).addTo(mymap);L.circle([i[1],i[0]],m.radius,{color:"none",fillColor:"#f03",fillOpacity:0.2}).addTo(mymap)}JSUTIL.injectLinkToHead("https://unpkg.com/leaflet@1.5.1/dist/leaflet.css");JSUTIL.injectScriptToHead("https://unpkg.com/leaflet@1.5.1/dist/leaflet.js",function(){JSUTIL.injectScriptToHead("./tp/leaflet.polylineDecorator.js",initMap)});var self=this;PB.sectionController={refreshSection:function(a){mymap.remove();self.initMap()}};